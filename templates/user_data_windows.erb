<script>
<% if message.has_key?("instance_name") %>
NETDOM RENAMECOMPUTER %COMPUTERNAME% /NewName:<%= message["instance_name"] %> /Force
<% end %>
<% if message["http_proxy"].nil? %>
REG delete HKLM\Environment /F /V https_proxy
REG delete HKCU\Environment /F /V https_proxy
REG delete HKLM\Environment /F /V http_proxy
REG delete HKCU\Environment /F /V http_proxy
<% else %>
setx http_proxy <%= message["http_proxy"] %> /M
setx HTTPS_PROXY <%= message["http_proxy"] %> /M
setx NO_PROXY "<%= message["domain"] %>,example.com,wonga.com" /M
<% end %>
winrm quickconfig -q & winrm set winrm/config/winrs @{MaxMemoryPerShellMB="2048"} & winrm set winrm/config/winrs @{MaxConcurrentUsers="100"} & winrm set winrm/config/winrs @{MaxProcessesPerShell="0"} & winrm set winrm/config/winrs @{MaxShellsPerUser="0"} & winrm set winrm/config @{MaxTimeoutms="1800000"} & winrm set winrm/config/service @{AllowUnencrypted="true"} & winrm set winrm/config/service/auth @{Basic="true"} & winrm set winrm/config/service/auth @{CredSSP="true"} & winrm set winrm/config/client @{TrustedHosts="*"}
winmgmt -standalone
netsh advfirewall firewall add rule name="WMIFixedPort" dir=in action=allow protocol=TCP localport=24158
</script>
<powershell>
<% if (message.has_key?("windows_set_admin_password")) && (message["windows_set_admin_password"] == true) && (message.has_key?("windows_set_admin_password")) %>
$admin = [adsi]("WinNT://./administrator, user")
$admin.psbase.invoke("SetPassword", "<%= message["windows_admin_password"] %>")
<% end %>
Set-ExecutionPolicy Unrestricted -force
Enable-WSManCredSSP -Role server -force
Restart-Computer -force
</powershell>
